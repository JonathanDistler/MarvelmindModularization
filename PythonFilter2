#gist of the code is to remove values that fall below a quality threshold
#credit to @fictionlab and the Marvelmind team

from marvelmind import MarvelmindHedge
from time import sleep, time  # Import time()
import sys
import pandas as pd 
import matplotlib.pyplot as plt

def main():
    hedge = MarvelmindHedge(tty="/dev/ttyACM0", adr=None, debug=False)  # Create MarvelmindHedge thread
    
    if len(sys.argv) > 1:
        hedge.tty = sys.argv[1]
    
    hedge.start()  # Start thread

    hedge_pos = pd.DataFrame(columns=["X", "Y", "Z", "Time"])  # Store position data  
    hedge_pos_filter = pd.DataFrame(columns=["X", "Y", "Z", "Time"])  # Store filtered data 
   
    threshold_val = 70  # Quality threshold
    initial_time = time()  # Capture the starting time

    while True:
        try:
            hedge.dataEvent.wait(1)
            hedge.dataEvent.clear()

            if hedge.positionUpdated:
                x = hedge.position()[1]
                y = hedge.position()[2]
                z = hedge.position()[3]
                t = time() - initial_time  # Compute time relative to start
                
                new_row = pd.DataFrame({"X": [x], "Y": [y], "Z": [z], "Time": [t]})
                hedge_pos = pd.concat([hedge_pos, new_row], ignore_index=True)

                if hedge.qualityUpdated:
                    quality = float(hedge.quality[1])  # Extract numerical quality value

                    if quality >= threshold_val:
                        hedge_pos_filter = pd.concat([hedge_pos_filter, new_row], ignore_index=True)
                        hedge.print_position()  # Print the position if it meets quality threshold

        except KeyboardInterrupt:
            hedge.stop()  # Stop and close serial port
            sys.exit()

# Call the main function
main()
